{{ $name := .Get 0 }}
{{ $pdfSrc := printf "%s.pdf" $name }}
{{ $pdf := .Page.Resources.Get $pdfSrc | fingerprint "md5" }}
{{ $svgSrc := printf "%s.artifact.svg" $name }}
{{ $svg := .Page.Resources.Get $svgSrc | fingerprint "md5" }}
<a href="{{ $pdf.RelPermalink }}" target="_blank" style="float: right; font-size: 12px; text-decoration: none;">ðŸ“„ View as PDF</a>
<div id="typst-app">
{{ $svg.Content | safeHTML }}
</div>
<script>
    function themeSVG() {
        const svg = document.querySelector('.post-content #typst-app svg.typst-doc');

        const style = document.createElement('style');

        style.textContent = `
            body.dark svg path.outline_glyph {
                fill: white;
            }

            body.dark svg path.typst-shape {
                stroke: white;
            }
        `;

        svg.appendChild(style);
    }

    function scaleSVG() {
        const post = document.querySelector('.post-content');
        const parent = post.querySelector('#typst-app');
        const svg = parent.querySelector('svg.typst-doc');
        const g = svg.querySelector('.typst-page');

        const { post_width, post_height } = post.getBoundingClientRect();
        const { width, height } = parent.getBoundingClientRect();

        orginal_width = parseInt(svg.getAttribute('data-width'));
        orginal_height = parseInt(svg.getAttribute('data-height'));

        const translateX = Math.max(0, (width - orginal_width) / 2);
        const scale = Math.max(1.0, width / orginal_width);

        g.setAttribute('transform', `translate(${-translateX}, 0) scale(${scale})`);

        const scaled_orginal_height = orginal_height * scale;

        svg.setAttribute('width', width);

        svg.setAttribute('height', scaled_orginal_height);

        const ratio = orginal_width / (width + 0.0);

        const viewbox_height = ratio >= 1.0 ? scaled_orginal_height * ratio : scaled_orginal_height;

        const parent_height = ratio >= 1.0 ? scaled_orginal_height / ratio : scaled_orginal_height;

        svg.setAttribute('viewBox', `0 0 ${orginal_width} ${ viewbox_height }`);

        parent.style.height = `${parent_height}px`;
    }
    window.addEventListener('resize', scaleSVG);
    document.addEventListener("DOMContentLoaded", scaleSVG);
    document.addEventListener("DOMContentLoaded", themeSVG);
</script>
